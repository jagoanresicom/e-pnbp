@model Pnbp.Entities.FilterPenerimaan
@{
	ViewBag.Judul = "Alokasi";
	var lsbulan = new List<SelectListItem>();
	lsbulan.Add(new SelectListItem { Value = "1", Text = "Januari" });
	lsbulan.Add(new SelectListItem { Value = "2", Text = "Februari" });
	lsbulan.Add(new SelectListItem { Value = "3", Text = "Maret" });
	lsbulan.Add(new SelectListItem { Value = "4", Text = "April" });
	lsbulan.Add(new SelectListItem { Value = "5", Text = "Mei" });
	lsbulan.Add(new SelectListItem { Value = "6", Text = "Juni" });
	lsbulan.Add(new SelectListItem { Value = "7", Text = "Juli" });
	lsbulan.Add(new SelectListItem { Value = "8", Text = "Agustus" });
	lsbulan.Add(new SelectListItem { Value = "9", Text = "September" });
	lsbulan.Add(new SelectListItem { Value = "10", Text = "Oktober" });
	lsbulan.Add(new SelectListItem { Value = "11", Text = "November" });
	lsbulan.Add(new SelectListItem { Value = "12", Text = "Desember" });


	var get_propinsi = ViewBag.get_propinsi;
	var pelayanan = ViewBag.pelayanan;
}

<style type="text/css">
	.back-to-top {
		cursor: pointer;
		position: fixed;
		bottom: 20px;
		right: 20px;
		display: none;
	}

	th {
		text-align: center;
	}
</style>
<script src="../resources/js/jquery.validate.min.js" type="text/javascript"></script>
<script src="../resources/js/jquery.validate.unobtrusive.min.js" type="text/javascript"></script>

<script src="../resources/js/moment.js"></script>
<script src="../resources/js/id.js"></script>
<script src="../resources/js/bootstrap-datetimepicker.min.js"></script>


<link href="../resources/css/dataTables.bootstrap.min.css" rel="stylesheet" />
<script src="../resources/js/jquery.dataTables.min.js"></script>
<script src="../resources/js/dataTables.bootstrap.min.js"></script>

<div id="dynamic_content">
	<div class="page-title">
		<div class="title_left">
		</div>
	</div>
	<div class="clearfix"></div>
	<div class="row">
		<div class="col-md-12 col-sm-12 col-xs-12">
			<div class="x_panel">
				<div class="x_title">
					<h2>Detail Alokasi</h2>
					<div class="clearfix"></div>
				</div>
				<div class="x_content">
					@*<form class="form-horizontal form-label-left" id="frmimportalok" method="post">
							<div class="form-group">
								<label class="control-label col-md-2 col-sm-2 col-xs-12">Import File Revisi Alokasi</label>
								<div class="col-md-6 col-sm-6 col-xs-12 hide-inputbtns">
									<button type="button" id="btn-upload" disabled="true" class="btn btn-success btn-file"><i class="fa fa-file-pdf-o"></i>&nbsp;&nbsp;Pilih File<input type="file" disabled="true" name="UploadFromFile" id="fileAlokasi" class="btn btn-success" accept=".xls,.xlsx" /></button>
								</div>
							</div>
							<div class="form-group">
								<label class="control-label col-md-2 col-sm-2 col-xs-12"></label>
								<div class="col-md-6 col-sm-6 col-xs-12 hide-inputbtns">
									<a href="@Url.Action("DownloadTemplateAlokasi", "Alokasi")" style="color:cornflowerblue" target="_blank">Download Template File Alokasi</a>
								</div>
							</div>
							<div class="form-group">
								<label class="control-label col-md-2 col-sm-2 col-xs-12"></label>
								<div class="col-md-6 col-sm-6 col-xs-12 hide-inputbtns">
									<button id="btn-alokasi" type="button" class="btn btn-success" disabled="true" style="margin-top:10px;"><i class="fa fa-paper-plane"></i>&nbsp;&nbsp;Proses Revisi Alokasi</button>
									<button id="btn-reset-alokasi" type="button" class="btn btn-warning btn-group-crop" style="margin-top:10px;"><i class="fa fa-arrow-circle-o-right"></i>&nbsp;&nbsp;Reset Alokasi</button>
									<button id="btn-kode-span" type="button" class="btn btn-danger btn-group-crop" style="display: none; margin-top: 10px;"><i class="fa fa-book"></i>&nbsp;&nbsp;Kode Span</button>
									<button id="btn-kode-program" type="button" class="btn btn-danger btn-group-crop" style="display: none; margin-top: 10px;"><i class="fa fa-book"></i>&nbsp;&nbsp;Program</button>
								</div>
							</div>
							<div class="form-group" id="notes" style="display: none;">
								<label class="control-label col-md-2 col-sm-2 col-xs-12"></label>
								<div class="col-md-6 col-sm-6 col-xs-12 hide-inputbtns">
									<span style="color:firebrick">Data Master Tidak Valid, Harap Isi Data Kode Span Dan Program</span>
									<br/>
									<span style="color:firebrick">Silakan Click Button Kode Span Dan Program</span>
								</div>
							</div>
						</form>*@

					@using (Html.BeginForm("Export", "Penerimaan", FormMethod.Post, new { id = "frmFindData", @class = "form-horizontal form-label-left" }))
					{
						<div class="form-group">
							<label class="control-label col-md-3 col-sm-3 col-xs-12">Provinsi</label>
							<div class="col-md-6 col-sm-6 col-xs-12">
								<select name="propinsi" id="propinsi" class="select2_single form-control input-md">
									<option value="">--Pilih Provinsi--</option>
									@if (get_propinsi.Count > 0)
									{
										foreach (var row in get_propinsi)
										{
											<option value="@row.kantorid">@row.nama_satker</option>
										}
									}
								</select>
							</div>
						</div>

						<div class="form-group">
							<label class="control-label col-md-3 col-sm-3 col-xs-12">Kab/Kota</label>
							<div class="col-md-6 col-sm-6 col-xs-12">
								<select name="satker" id="satker" class="select2_single form-control input-md">
									<option value="">--Pilih Satker--</option>
								</select>
							</div>
						</div>
					}

				</div>
				<div style="text-align:center;">
					<div style="text-align:center;">
						<div class="col-md-3 col-sm-3 col-xs-12 col-md-offset-3">
							<button id="find-btn" type="button" class="btn btn-success">Cari</button>
							@*<button id="reset-btn" type="reset" class="btn btn-warning">Hapus</button>*@
						</div>
						<div class="col-md-2 col-sm-2 col-xs-12">
							@*<button id="dl-btn" type="submit" form="frmFindData" class="btn btn-success"><span class="fa fa-floppy-o"></span> Excel </button>*@
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="tableholder">
	</div>

	<div class="x_panel">

		<form class="form-horizontal form-label-left pnbp-group-table" id="frmdatasatker" method="post" data-name="alokasi">
			<div class="form-group pnbp-table-container" id="group_alokasi" style="margin-top:10px;">
				<table id="alokasisatker" class="table table-striped table-bordered">
					<thead>
						<tr>
							<th>No</th>
							<th>Kode Satker</th>
							<th>Nama Satker</th>
							<th>Pagu</th>
							@*<th>Alokasi Saat Ini</th>*@
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</form>

	</div>
</div>

<template id="tmp-alokasisatker">

	<table id="alokasisatker" class="table table-striped table-bordered">
		<thead>
			<tr>
				<th>No</th>
				<th>Kode Satker</th>
				<th>Nama Satker</th>
				<th>Pagu</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>

</template>

<a id="back-to-top" href="#" class="btn btn-primary back-to-top" role="button" title="" data-toggle="tooltip" data-placement="left"><span class="glyphicon glyphicon-chevron-up"></span></a>

<script type="text/javascript">

    $(document).ready(function () {

		$('.select2_single').select2({ width: 'resolve' });

        $(window).scroll(function () {
            if ($(this).scrollTop() > 50) {
                $('#back-to-top').fadeIn();
            } else {
                $('#back-to-top').fadeOut();
            }
        });
        // scroll body to 0px on click
        $('#back-to-top').click(function () {
            $('#back-to-top').tooltip('hide');
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });

        $('#propinsi').change(function () {
            var provinsi = $('#propinsi').val()
            $.ajax({
                url: '@Url.Action("satker", "Penerimaan")',
                type: "GET",
                dataType: "JSON",
                data: { kode: provinsi },
                success: function (data) {
                    //console.log(data[0].KantorId);
					var html = "<option>--Pilih Satker--</option>";
                    if (data.length > 0) {
                        $.each(data, function (x) {
                            html += ""
                            + "<option value='" + data[x].KantorId + "'>" + data[x].Nama + "</option>"
                        })
                    } else {
                        + "<option>Data Kosong</option>"
                    }
                    $("#satker").html(html);
                }
            });
        })

        $('#back-to-top').tooltip('show');

        getValidateKodeSpan();
        getAlokasi();
	});


	$("#find-btn").on("click", function (e) {
        let bulan = $('#bulan').val(),
            kodeSpopp = $('#pelayanan').val(),
            satker = $('#satker').val();

        //if (tblAlokasi == null) {
        //    $('#tbl-alokasi0').removeClass('hidden');
        //    tblAlokasi = initDt(satker, kodeSpopp, tahun, bulan);
        //} else {
        //    //tblAlokasi.ajax.url("/MonitoringEvaluasi/AlokasiDT?kantorId=" + satker + "&kodeSpopp=" + kodeSpopp + "&tahun=" + tahun + "&bulan=" + bulan + "&statusAlokasi=false").load();
        //    tblAlokasi.ajax.url("/MonitoringEvaluasi/AlokasiDTV2?tahun=" + tahun).load();
        //}

		var urlObject = new URL(document.location.href);
        var params = urlObject.searchParams;
        var id = params.get("id");

		var frm = new FormData();
		frm.append("id", id);
		frm.append("bulan", bulan);
		frm.append("satker", satker);
        frm.append("pelayanan", kodeSpopp);

		$.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
        $.ajax({
            type: "POST",
            url: '@Url.Action("ListAlokasiBySummaryId", "Alokasi")',
            data: frm,
			contentType: false,
			processData: false,
            success: function (res) {
                if (!res.success || res.data.length == 0) {
                    $('#btn-alokasi').prop('disabled', true);
                    $('#btn-reset-alokasi').prop('disabled', true);
                } else {
                    $('#btn-alokasi').prop('disabled', false);
                    $('#btn-reset-alokasi').prop('disabled', false);
                }

                writeDataTable(res);
                $.unblockUI();
            }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.unblockUI();
            }
        });

        e.preventDefault();
        return false;
	});



    function addCommas(nStr) {
        nStr += '';
        x = nStr.split(',');
        x1 = x[0];
        x2 = x.length > 1 ? ',' + x[1] : '';
        var rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + '.' + '$2');
        }
        return x1 + x2;
    }

    var dfAlokasi = null;

    function getAlokasi() {
        var urlObject = new URL(document.location.href);
        var params = urlObject.searchParams;
        var id = params.get("id");
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetAlokasiBySummaryId", "Alokasi")?id='+id,
            success: function (res) {
                if (!res.success || res.data.length == 0) {
                    $('#btn-alokasi').prop('disabled', true);
                    $('#btn-reset-alokasi').prop('disabled', true);
                } else {
                    $('#btn-alokasi').prop('disabled', false);
                    $('#btn-reset-alokasi').prop('disabled', false);
                }

                writeDataTable(res);
                $.unblockUI();
            }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.unblockUI();
            }
            });
    }

    function getValidateKodeSpan() {
        $.ajax({
            type: "GET",
            url: '@Url.Action("IsKodeSpanValid", "Alokasi")',
            success: function (res) {
                $('#fileAlokasi').prop('disabled', false);
                $('#btn-upload').prop('disabled', false);
                if (res.success && res.data) {
                    $('#btn-kode-span').hide();
                    $('#btn-kode-program').hide();
                    $('#notes').hide();
                    console.log("Kode Sapn Valid");
                } else {
                    $('#btn-alokasi').prop('disabled', true);
                    $('#btn-kode-span').show();
                    $('#btn-kode-program').show();
                    $('#notes').show();
                    console.log("Kode Sapn Not Valid");
                }
                $.unblockUI();
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.unblockUI();
            }});
    }

    $('#btn-kode-span').on('click', function () {
        window.location.href = '@Url.Action("Index", "KodeSpan")'
    });

    $('#btn-kode-program').on('click', function () {
        window.location.href = '@Url.Action("Index", "Program")'
    });

    function writeDataTable(res) {
        var html = "";
        $("#group_alokasi").html(html);
		let template = $("#tmp-alokasisatker")[0].content.cloneNode(true);
		$(template).appendTo("#group_alokasi");

        if (res.data != null && res.data != undefined && res.data.length > 0) {
            var data = res.data;
            var i = 0;

            var tr = document.getElementById('alokasisatker').tHead.children[0];
            if (data[0].DaftarRevisi != null && data[0].DaftarRevisi.length > 0) {
                var th = document.createElement('th');
                th.innerHTML = "Alokasi 1";
                tr.appendChild(th);

                $.each(data[0].DaftarRevisi, function (x) {
                    var th = document.createElement('th');
                    if ((x + 1) == data[0].DaftarRevisi.length) {
                        th.innerHTML = "Alokasi Saat Ini";
                    } else {
                        th.innerHTML = "Alokasi " + (x + 2);
                    }
                    tr.appendChild(th);
                });
            } else {
                var th = document.createElement('th');
                th.innerHTML = "Alokasi Saat Ini";
                tr.appendChild(th);
            }

            if (data[0].TempAlokasi != null) {
                var th = document.createElement('th');
                th.innerHTML = "Revisi Alokasi";
                tr.appendChild(th);
            }

            $.each(data, function (x) {
                i = x + 1;
                html += ""
                    + "<tr>"
                    + "<td class='text-center'>" + i + "</td>"
                    + "<td class='text-left'>" + data[x].KodeSatker + " </td>"
                    + "<td class='text-left'>" + data[x].NamaSatker + " </td>"
                    + "<td class='text-right'>" + addCommas(data[x].Pagu) + "</td>"
                    + "<td class='text-right'>" + addCommas(data[x].Alokasi) + "</td>"
                    ;

                if (data[x].DaftarRevisi != null && data[x].DaftarRevisi.length > 0) {
                    for (var index = 0; index < data[x].DaftarRevisi.length; index++) {
                        html += ""
                            + "<td class='text-right'>" + addCommas(data[x].DaftarRevisi[index].Alokasi) + "</td>";
                    }
                }

                if (data[x].TempAlokasi != null) {
                    html += ""
                        + "<td class='text-right' "
                        + (data[x].IsNilaiBaru ? "style='color: red; font-weight: bold;'" : "")
                        + ">" + addCommas(data[x].TempAlokasi) + "</td>";
                }

                html += "</tr>"
            });
            $("#index").val(i);
        } else {
            html = "<tr><td colspan='9' class='text-center'>Data Tidak Tersedia</td></tr>";
        }

        $("#alokasisatker>tbody").html(html);
    }

    function showDetailAlokasiSummary(id) {

    }

</script>


