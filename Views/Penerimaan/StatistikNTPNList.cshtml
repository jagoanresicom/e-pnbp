@model Pnbp.Entities.QueryStatistikNTPN

@{
    ViewBag.Title = "Statistik NTPN";
    var culture = new System.Globalization.CultureInfo("id-ID");
}

<style type="text/css">
    #eventsTable > tbody > tr {
        cursor: pointer;
    }

    #eventsTable2 > tbody > tr {
        cursor: pointer;
    }

    .back-to-top {
        cursor: pointer;
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: none;
        z-index: 10001;
    }

    .select2-container--default .select2-selection--single {
        border-radius: 0px;
    }

    .input-group {
        margin-bottom: 0;
    }

    .deffcolumn {
        text-align: right;
    }

    .dataTables_processing.panel.panel-default {
        padding-top: 3px;
    }

    /* For Firefox */
    input[type='number'] {
        -moz-appearance: textfield;
    }

    /* Webkit browsers like Safari and Chrome */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>

<script src='@Url.Content("~/resources/js/jquery.validate.min.js")' type="text/javascript"></script>
<script src='@Url.Content("~/resources/js/jquery.validate.unobtrusive.min.js")' type="text/javascript"></script>

<script src='@Url.Content("~/resources/js/moment.js")' type="text/javascript"></script>
<script src='@Url.Content("~/resources/js/id.js")' type="text/javascript"></script>
<script src='@Url.Content("~/resources/js/bootstrap-datetimepicker.min.js")' type="text/javascript"></script>

<script src='@Url.Content("~/resources/js/infiniteScroll.js")' type="text/javascript"></script>

<link href='@Url.Content("~/resources/css/bootstrap-datetimepicker.css")' rel="stylesheet">
<link href='@Url.Content("~/resources/css/dataTables.bootstrap.min.css")' rel="stylesheet">
<script src='@Url.Content("~/resources/js/jquery.dataTables.min.js")' type="text/javascript"></script>
<script src='@Url.Content("~/resources/js/dataTables.bootstrap.min.js")' type="text/javascript"></script>

<div id="dynamic_content">
    <div class="page-title">
        <div class="title_left">
        </div>
    </div>
    <div class="clearfix"></div>
    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Pilih kantor</h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li><a class="collapse-link"><i class="fa fa-chevron-up" title="Hide Form"></i></a></li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <form class="form-horizontal form-label-left" id="frmQueryStatistikNTPN" role="form">
                        <div class="form-group" id="cbProp">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Propinsi : </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                @if (this.ViewData["tipeKantor"].ToString() == "2" || this.ViewData["tipeKantor"].ToString() == "3")
                                {
                                    @Html.DropDownListFor(m => Model.propinsi, new SelectList(@Model.propinsi, "kode", "nama"), new { @class = "select2_single form-control", @id = "idprop", @style = "width:100%;", @onchange = "FillKabupaten()" })
                                }
                                else
                                {
                                    @Html.DropDownListFor(m => Model.propinsi, new SelectList(@Model.propinsi, "kode", "nama"), "-- Pilih Propinsi --", new { @class = "select2_single form-control", @id = "idprop", @style = "width:100%;", @onchange = "FillKabupaten()" })
                                }
                                @*@Html.ValidationMessageFor(m => m.wilayah, "", new { @class = "text-danger" })*@
                            </div>
                        </div>
                        <div class="form-group" id="cbKab">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Kota/Kabupaten : </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                @if (this.ViewData["tipeKantor"].ToString() == "3")
                                {
                                    @Html.DropDownListFor(m => Model.selectedKabupaten, new SelectList(@Model.kabupaten, "id", "nama"), new { @class = "select2_single form-control", @id = "idkab", @style = "width:100%;" })
                                }
                                else
                                {
                                    @Html.DropDownListFor(m => Model.selectedKabupaten, new SelectList(@Model.kabupaten, "id", "nama"), "-- Pilih Kabupaten --", new { @class = "select2_single form-control", @id = "idkab", @style = "width:100%;" })
                                }
                                @*@Html.ValidationMessageFor(m => m.wilayah, "", new { @class = "text-danger" })*@
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Sejak : </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <div class='input-group date' id='TanggalMulai' style="margin-bottom: 0px;">
                                    @Html.TextBoxFor(model => model.TanggalMulai, new { @class = "form-control" })
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                </div>
                                @*<div class='input-group date' id='tglMulai' style="margin-bottom:0px;">
                                        @Html.TextBoxFor(m => m.TanggalMulai, "{0:dd/MM/yyyy}", new { @class = "form-control", type = "text" })
                                        <span class="input-group-addon">
                                            <span class="glyphicon glyphicon-calendar"></span>
                                        </span>
                                    </div>*@
                                @Html.ValidationMessageFor(m => m.TanggalMulai, "", new { @class = "error" })
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Sampai : </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <div class='input-group date' id='TanggalSampai' style="margin-bottom: 0px;">
                                    @Html.TextBoxFor(model => model.TanggalSampai, new { @class = "form-control" })
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                </div>
                                @*<div class='input-group date' id='tglSampai'>
                                        @Html.TextBoxFor(m => m.TanggalSampai, "{0:dd/MM/yyyy}", new { @class = "form-control", type = "text" })
                                        <span class="input-group-addon">
                                            <span class="glyphicon glyphicon-calendar"></span>
                                        </span>
                                    </div>*@
                                @Html.ValidationMessageFor(m => m.TanggalSampai, "", new { @class = "error" })
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Kode Billing : </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                @*<select name="kodeBilling" id="kodeBilling" class="select2_single form-control" data-placeholder="Pilih Kode Billing">
                                        <option value="">-Pilih Kode Billing-</option>
                                        <option value="820190201341480">820190201341480</option>
                                        <option value="820190201345273">820190201345273</option>
                                        <option value="820190201377830">820190201377830</option>
                                        <option value="820190201381345">820190201381345</option>
                                        <option value="820190201382114">820190201382114</option>
                                        <option value="820190201385527">820190201385527</option>
                                        <option value="820190201387195">820190201387195</option>
                                        <option value="820190201387762">820190201387762</option>
                                        <option value="820190201388184">820190201388184</option>
                                    </select>*@
                                <input type="text" name="kodeBilling" id="kodeBilling" class="form-control" placeholder="Masukkan Kode Billing" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">NTPN : </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <input type="text" name="ntpn" id="ntpn" class="form-control" placeholder="Masukkan NTPN" />
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-5">
                                <button type="submit" class="btn btn-success">Cari</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Hasil Pencarian Kantor</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <div role="tabpanel" id="tabs">
                        <ul id="actTabs" class="nav nav-tabs bar_tabs" role="tablist">
                            @*<li role="presentation" class="active">
                                    <a href="#tab1" id="home-tab" role="tab" data-toggle="tab" aria-expanded="true">Daftar</a>
                                </li>*@
                            <li role="presentation" class="active">
                                <a href="#tab2" id="detail-tab" role="tab" data-toggle="tab" aria-expanded="true">Detil</a>
                            </li>
                        </ul>
                    </div>
                    <div id="tab-content" class="tab-content">
                        @*<div role="tabpanel" class="tab-pane fade active in" id="tab1" aria-labelledby="home-tab">
                                <div class="table-responsive">
                                    <table id="eventsTable" class="table table-striped table-bordered" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th style="text-align:center;">No.</th>
                                                <th style="text-align:center;">Nama Satker</th>
                                                <th style="text-align:center;">Jumlah NTPN</th>
                                                <th style="text-align:center;">Jumlah Berkas</th>
                                                <th style="text-align:center;">Nilai NTPN (Rp)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="statistikntpnrows"></tbody>
                                    </table>
                                </div>
                                @Html.Partial("_Loading")
                            </div>*@
                        <div role="tabpanel" class="tab-pane fade active in" id="tab2" aria-labelledby="detail-tab">
                            <div class="table-responsive">
                                <table id="eventsTable2" class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th style="text-align:center;">No.</th>
                                            @*<th style="text-align:center;">Nama Kantor</th>*@
                                            <th style="text-align:center;">Nomor Berkas</th>
                                            <th style="text-align:center;">Tahun Berkas</th>
                                            <th style="text-align:center;">Kode Billing</th>
                                            <th style="text-align:center;">Tanggal Billing</th>
                                            <th style="text-align:center;">NTPN</th>
                                            <th style="text-align:center;">Tanggal NTPN</th>
                                            <th style="text-align:center;">Jumlah (Rp)</th>
                                            <th style="text-align:center;">Nomor DI305</th>
                                            <th style="text-align:center;">Tanggal DI305</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailplaceholder"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal_ntpn" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Hasil Pencarian Berkas</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">NTPN</label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                : <span id="kodentpn"></span>
                            </div>
                        </div><br />
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Kode Billing</label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                : <span id="modalkodebilling"></span>
                            </div>
                        </div><br />
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Tanggal Penerimaan</label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                : <span id="tanggalpenerimaan"></span>
                            </div>
                        </div><br />
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Nama Kantor</label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                : <span id="namakantor"></span>
                            </div>
                        </div><br />
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Nama Prosedur</label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                : <span id="namaprosedur"></span>
                            </div>
                        </div><br />
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Nama Wajib Bayar</label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                : <span id="wajibbayar"></span>
                            </div>
                        </div><br />
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Total Biaya</label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                : <span id="totalbiaya"></span>
                            </div>
                        </div><br />
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Detail Penerimaan</label>
                            <div class="col-md-9 col-sm-9 col-xs-12">
                                : <span id="detailpenerimaan"></span>
                            </div>
                        </div><br />
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Status Berkas</label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                : <span id="statusberkas"></span>
                            </div>
                        </div><br />
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Nomor Berkas</label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                : <span id="nomorberkas"></span> / <span id="tahun"></span>
                            </div>
                        </div><br />
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">NTB</label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                : <span id="ntb"></span>
                            </div>
                        </div><br />
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Nomor DI305</label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                : <span id="nodi305"></span>
                            </div>
                        </div><br />
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">Tanggal DI305</label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                : <span id="tgl305"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>

</div>
<a id="backtotop" href="#" class="btn btn-primary back-to-top" role="button" title="Click to return on the top page" data-toggle="tooltip" data-placement="left"><span class="glyphicon glyphicon-chevron-up"></span></a>

<script>

    $(function () {
        $("div#loading").hide();
    });

    $(function () {
        $.validator.methods.date = function (value, element) {
            return this.optional(element) || moment(value, "DD/MM/YYYY", true).isValid();
        }
    });

    $(document).ready(function () {
        @*var tipekantor = @Html.Raw(Json.Encode(this.ViewData["tipeKantor"]));
        console.log(tipekantor);
        if(tipekantor == '3' || tipekantor == '4'){
            $('#cbProp').hide();
            $('#cbKab').hide();
        }*@
        $('.select2_single').select2({ width: 'resolve' });

        $('#TanggalMulai').datetimepicker({
            format: 'DD/MM/YYYY',
            locale: 'id'
        });

        $('#TanggalSampai').datetimepicker({
            format: 'DD/MM/YYYY',
            locale: 'id'
        });

        //createPaging();
        $('#eventsTable tbody').on('click', 'tr', function () {
            var data = dtable.row(this).data();
            if (data) {
                if (dtable2) { dtable2.destroy(); }
                getDetail(data.kantorid);
                $('#actTabs a[href="#tab2"]').tab("show");
                console.log('show detail click');
            }
        });


        $('#eventsTable2 tbody').on('click', 'tr', function () {
            var data = dtable2.row(this).data();
            getDataModal(data.kodeBilling);
            $('#modal_ntpn').modal('show');
        });
    });

    function getDataModal($kodebilling) {
        var kodebilling = $kodebilling;
        $.ajax({
            //url: '/Penerimaan/ShowDetailModalNTPN/' + kodebilling,
            url: '@Url.Action("ShowDetailModalNTPN", "Penerimaan")',
            type: "GET",
            dataType: "JSON",
            data: { kodeBilling: kodebilling },
            success: function (data) {
                //console.log(data.data[0].tgl305);
                $('#kodentpn').html(data.data[0].ntpn);
                $('#modalkodebilling').html(data.data[0].kodebilling);
                $('#tanggalpenerimaan').html(data.data[0].tanggal);
                $('#namakantor').html(data.data[0].namakantor);
                $('#namaprosedur').html(data.data[0].namaprosedur);
                $('#wajibbayar').html(data.data[0].nama_wajib_bayar);
                $('#totalbiaya').html(addCommas(data.data[0].jumlahdi305));
                $('#detailpenerimaan').html(data.data[0].jenispenerimaan);
                $('#nomorberkas').html(data.data[0].nomorberkas);
                $('#tahun').html(data.data[0].tahun);
                $('#statusberkas').html(data.data[0].tipe);
                $('#ntb').html(data.data[0].ntb);
                $('#nodi305').html(data.data[0].nomor);
                $('#tgl305').html(data.data[0].tgl305);
            }
        });
    }

    function addCommas(nStr)
    {
        nStr += '';
        x = nStr.split(',');
        x1 = x[0];
        x2 = x.length > 1 ? ',' + x[1] : '';
        var rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + '.' + '$2');
        }
        return x1 + x2;
    }

    $("#frmQueryStatistikNTPN").submit(function (e) {
        if ($("#frmQueryStatistikNTPN").valid()) {
            getDetail()
    //        if (dtable) dtable.destroy();
    //        if (dtable2) { $('#detailplaceholder').html(""); }
    //        createPaging();
    //        $('#actTabs a[href="#tab1"]').tab("show");
        }
        e.preventDefault();
        return false;
    });

    function FillKabupaten() {
        var stateId = $('#idprop').val();
        if (stateId) {
            $.ajax({
                url: '/Penerimaan/FillCity',
                type: "GET",
                dataType: "JSON",
                data: { kode: stateId },
                success: function (kabupaten) {
                    $("#idkab").html(""); // clear before appending new list
                    $.each(kabupaten, function (i, kabupaten) {
                        $("#idkab").append(
                        $('<option></option>'),
                        $('<option></option>').val(kabupaten.id).html(kabupaten.nama)
                        );
                    });
                }
            });
        }
        else
        {
            $("#idkab").html("");
        }
    }

    //var OpenDetailStatikNTPN = function (v) {
    //    //console.log($('#frmQueryStatistikNTPN').serializeArray());
    //    $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
    //    $.pjax({
    //        container: "#statistikntpnrows",
    //        type: 'POST',
    //        url: '/Penerimaan/ShowDetailNTPN',
    //        data: $('#frmQueryStatistikNTPN').serialize() + "&pKantorId=" + v
    //    });
    //}

    var OpenDetailStatikNTPN = function (v) {
        //console.log($('#frmQueryStatistikNTPN').serializeArray());
        var provinsi = $('#idprop').val();
        console.log(provinsi);
        $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
        $.pjax({
            container: "#detailplaceholder",
            type: 'POST',
            url: '/Penerimaan/ShowDetailNTPN',
            data: $('#frmQueryStatistikNTPN').serialize() + "&pKantorId=" + v
        });
    }

    var dtable2;
    var getDetail = function (id, row) {
        //$("#eventsTable2").DataTable();
        dtable2 = $("#eventsTable2").DataTable({
            "bLengthChange": false,
            "paging": true,
            "pageLength": 100,
            "bFilter": false,
            "ordering": false,
            "info": false,
            "processing": true,
            "serverSide": true,
            "ajax": {
                url: '@Url.Action("ShowDetailNTPN", "Penerimaan")',
                type: "POST",
                data: function (data, obj) { var form = $('#frmQueryStatistikNTPN').serializeArray(); form.push({ name: "draw", value: data.draw }, { name: "start", value: data.start }, { name: "length", value: data.length }, { name: "pKantorId", value: id }); return form; }
            },
            "columns": [
                { "data": "rnumber", "width": "5%" },
                { "data": "nomorberkas" },
                { "data": "tahunberkas" },
                { "data": "kodebilling" },
                { "data": "tglbilling" },
                { "data": "ntpn" },
                { "data": "tglntpn" },
                { "data": "jumlah", "className": "deffcolumn", render: formatangka },
                { "data": "nomor305" },
                { "data": "tgl305" }
            ]
        });
    };

    var formatangka = function (data, type, row) {
        return "".concat(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    };
    var dtable;
    var createPaging = function () {
        dtable = $("#eventsTable").DataTable({
            "bLengthChange": false,
            "paging": true,
            "pageLength": 100,
            "bFilter": false,
            "ordering": false,
            "info": false,
            "processing": true,
            "serverSide": true,
            "ajax": {
                url: '@Url.Action("StatistikNTPNRows", "Penerimaan")',
                type: "POST",
                data: function (data, obj) { var form = $('#frmQueryStatistikNTPN').serializeArray(); form.push({ name: "draw", value: data.draw }, { name: "start", value: data.start }, { name: "length", value: data.length }); return form; }
            },
            "columns": [
                { "data": "rnumber", "width": "5%" },
                { "data": "namakantor", "width": "40%" },
                { "data": "jumlahntpn", "className": "deffcolumn", "width": "15%", render: formatangka },
                { "data": "jumlahberkas", "className": "deffcolumn", "width": "15%", render: formatangka },
                { "data": "nilaintpn", "className": "deffcolumn", "width": "15%", render: formatangka }]
        });
    };

</script>
