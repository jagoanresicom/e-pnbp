
@model Pnbp.Entities.FindPengembalianPnbp

@{
    ViewBag.Title = "PengajuanPengembalianIndex";
    var tipekantorid = ViewData["tipekantorid"].ToString();
    var datasatker = ViewBag.datasatker;
    var kantorid = ViewBag.kantorid;

}

<div class="" id="dynamic_content">
    
    <div class="clearfix"></div>

    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel" style="padding-top:10px; border:1px solid #E6E9ED;">
                <div class="x_title">
                    <h2>Pencarian Data</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <form class="form-horizontal form-label-left" id="frmCariPengajuan" method="post">

                        <div class="row">
                            <div class="col-md-10 col-xs-12">
                                <div class="form-group">
                                    <label class="control-label col-md-4 col-sm-4 col-xs-12">Nama Pemohon : </label>
                                    <div class="col-md-8 col-sm-8 col-xs-12">
                                        @Html.TextBoxFor(model => model.CariNamaPemohon, new { @class = "form-control", @id = "namapemohon" })
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-md-4 col-sm-4 col-xs-12">Status </label>
                                    <div class="col-md-8 col-sm-8 col-xs-12">
                                        @*@Html.TextBoxFor(model => model.IsDisetujui, new { @class = "form-control" })*@
                                        <select name="CariStatus" id="CariStatus" class="form-control">
                                            <option value="">Pilih status</option>
                                            <option value="0">Belum Kirim</option>
                                            @if (@OtorisasiUser.GetJenisKantorUser() == "Pusat")
                                            {
                                                <option value="1">Usulan Baru</option>
                                            }
                                            else
                                            {
                                                <option value="1">Terkirim</option>
                                            }
                                            <option value="2">Proses</option>
                                            <option value="3">Berkas Tidak Lengkap</option>
                                            <option value="4">Selesai</option>
                                        </select>
                                    </div>
                                </div>
                                @if (@OtorisasiUser.GetJenisKantorUser() == "Pusat")
                                {
                                <div class="form-group">
                                    <input type="hidden" name="jeniskantor" id="jeniskantor" value="Pusat" />
                                    <label class="control-label col-md-4 col-sm-4 col-xs-12">Satker : </label>
                                    <div class="col-md-8 col-sm-8 col-xs-12">
                                        @*@Html.TextBoxFor(model => model.CariNamaSatker, new { @class = "form-control" })*@
                                        <select name="CariKodeSatker" id="CariKodeSatker" class="form-control">
                                            <option value=""></option>
                                            @foreach (var row in datasatker)
                                            {
                                                <option value="@row.KodeSatker">@row.Nama_Satker</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                }
                                else
                                {
                                    <input type="hidden" name="jeniskantor" id="jeniskantor" value="Kantah" />
                                }
                            </div>
                            <div class="col-md-2 col-xs-12">
                            @if (@OtorisasiUser.GetJenisKantorUser() == "Kantah" || @OtorisasiUser.GetJenisKantorUser() == "Kanwil")
                            {
                                <a href="@Url.Action("InputPengajuan", "Pengembalian")" class="btn btn-lg btn-primary">Buat Baru</a>
                            }

                            @if (kantorid == "980FECFC746D8C80E0400B0A9214065D" || kantorid == "980FECFC746D8C80E0400B0A9214068D" || kantorid == "980FECFC746D8C80E0400B0A9214066D")
                            {
                                <a href="@Url.Action("InputPengajuan", "Pengembalian")" class="btn btn-lg btn-primary">Buat Baru</a>
                            }

                            </div>
                        </div>
                        
                    </form>

                    <div class="text-center">
                        <div class="col-md-12 col-sm-12 col-xs-12 col-md-offset-0">
                            <button id="btnCari" type="submit" form="frmCariPengajuan" class="btn btn-primary">&nbsp;Cari&nbsp;</button>
                            @*@if (@OtorisasiUser.GetJenisKantorUser() == "Pusat")
                            {*@
                                <a href="javascript:void(0);" class="btn btn-success" style="margin-left:7px" onclick="exportPengembalian();"><span class="fa fa-floppy-o"></span> Excel</a>
                            @*}*@
                            @*<button id="btnReset" type="reset" form="frmCariPengajuan" class="btn btn-warning">Reset</button>*@
                            @*<button id="btnCreate" type="button" class="btn btn-primary">Buat Baru</button>*@
                           
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page-title">
        <div class="title_left"><h2 style="width:100%">Daftar Pengajuan Permohonan</h2></div>
        <div class="clearfix"></div>
    </div>

    <table id="myTablePengembalianPnbp" class="table table-striped table-bordered" style="width:100%; background-color:white;">
        <thead>
            <tr>
                <th style="text-align:center;">No.</th>
                <th>Kode Satker</th>
                <th>Nama Satker</th>
                <th>Nama Pemohon</th>
                <th>Nomor Berkas</th>
                <th>Nomor Surat</th>
                <th>Nama Bank</th>
                <th>Nominal Pengajuan</th>
                <th>Tanggal Pengajuan</th>
                <th>Status</th>
                @*<th>Aksi</th>*@
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<a id="back-to-top" href="#" class="btn btn-primary back-to-top" role="button" title="" data-toggle="tooltip" data-placement="left"><span class="glyphicon glyphicon-chevron-up"></span></a>

<script type="text/javascript">
     @if(TempData["Upload"] != null) { <text>
                $(document).ready(function()
                {
                    @*swal({
                        title: "Berhasil",
                        text: "@TempData["Upload"]",
                        type: "success"
                });*@
            });
     </text>
    }

    function exportPengembalian()
    {
        var namapemohon = $('#namapemohon').val();
        var status = $('#CariStatus').val();
        var nama_satker = $('#CariKodeSatker').val();
        //console.log(status);
        @*window.location.replace('@Url.Action("ExportPengembalian", "Pengembalian")?pTahun=' + year);*@
        window.location.replace('@Url.Action("ExportPengembalian", "Pengembalian")?pNamaPemohon=' + namapemohon + '&pStatus=' + status + '&pNamaSatker=' + nama_satker);
        @*window.location.replace('@Url.Action("Exportntpn", "Administrasi")?pTahun=' + year + '&pBulan=' + month);*@
    }

    $(document).ready(function () {
        $('#CariKodeSatker').select2({
            placeholder: "Pilih Satker"
        });
        if (@tipekantorid != "1") {
            $('#DivSearch_Wilayah').addClass('hidden');
            $('#Th_Wilayah').addClass('hidden');
            //Th_Hapus
        }
        if (@tipekantorid == "1") {
            $('#Th_Hapus').addClass('hidden');
            $('#Th_Entri').addClass('hidden');
            $('#btnCreate').addClass('hidden');
        }

        createPagingPengajuan();

        $(window).scroll(function () {
            if ($(this).scrollTop() > 50) {
                $('#back-to-top').fadeIn();
            } else {
                $('#back-to-top').fadeOut();
            }
        });
        // scroll body to 0px on click
        $('#back-to-top').click(function () {
            $('#back-to-top').tooltip('hide');
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });

        $('#back-to-top').tooltip('show');
    });

    $("#btnCreate").click(function (e) {
        window.location.href = '@Url.Action("EntriPengajuan", "Pengembalian")';

        e.preventDefault();
        return false;
    });

    $("#frmCariPengajuan").submit(function (e) {
        dtablePengajuan.ajax.reload(null, true);
        e.preventDefault();
        return false;
    });

    var dtablePengajuan;
    var createPagingPengajuan = function () {
        var kantorid = "@(userIdentity.KantorId)";
        dtablePengajuan = $('#myTablePengembalianPnbp').DataTable({
            "bLengthChange": false,
            "paging": true,
            "pageLength": 10,
            "bFilter": false,
            "ordering": false,
            "info": false,
            "processing": true,
            "serverSide": true,
            "scrollX": false,
            "ajax": {
                url: '@Url.Action("DaftarPengajuanPengembalianTrain", "Pengembalian")',
                type: "POST",
                data: function (data, obj) { var ftp = $('#frmCariPengajuan').serializeArray(); data.form = ftp; ftp.push({ name: "start", value: data.start }, { name: "length", value: data.length }); return ftp; }
            },
            "columns": [
                { "data": "RNumber", "className": "centertaligncolumn", "width": "5%" },
                {
                    "data": "KodeSatker",
                    "className": "leftaligncolumn",
                    //"width": "10%",
                    render: function (data) {
                            return '<a href="#" >'+data+'</a>'
                    }
                },
                {
                    "data": "NamaSatker",
                    "className": "leftaligncolumn",
                    //"width": "10%",
                    render: function (data) {
                        return '<a href="#" >'+data+'</a>'
                    }
                },
                {
                    "data": "NamaPemohon",
                    "className": "leftaligncolumn",
                    //"width": "10%",
                    render: function (data) {
                        return '<a href="#" >'+data+'</a>'
                    }
                },
                {
                    "data": "NomorBerkas",
                    "className": "leftaligncolumn",
                    //"width": "10%",
                    render: function (data) {
                        return '<a href="#" >'+data+'</a>'
                    }
                },
                {
                    "data": "NomorSurat",
                    "className": "lefttaligncolumn",
                    //"width": "10%",
                    render: function (data) {
                        return '<center><a href="#" >'+((data!=null)?data:'-')+'</a></center>'
                    }
                },
                {
                    "data": "NamaBank",
                    "className": "leftaligncolumn",
                    //"width": "10%",
                    render: function (data) {
                        return '<a href="#" >'+data+'</a>'
                    }
                },
                { "data": "permohonanpengembalian", "className": "rightaligncolumn", render: formatangka },
                { "data": "TanggalPengaju" },
                //{ "data": 'KodeBilling' },
                {
                    "data": "StatusPengembalian",
                    "className": "centertaligncolumn",
                    //"width": "10%",
                    render: function (data) {
                        if (data == null) {
                            //return '<b class="fa fa-close" style="color:#ce3535;"></b>';
                            return '<a href="#" >Belum Kirim</a>'
                        }
                        if (data == '0') {
                            //return '<b class="fa fa-close" style="color:#ce3535;"></b>';
                            return '<a href="#" >Belum Kirim</a>'
                        }
                        if (data == '1') {
                            if (kantorid == '980FECFC746D8C80E0400B0A9214067D')
                            {
                                //return '<b class="fa fa-close" style="color:#ce3535;"></b>';
                                return '<a href="'+data.KodeSatker+'" >Usulan Baru</a>'
                            } else {
                                return '<a href="'+data.KodeSatker+'" >Terkirim</a>'
                            }

                        }
                        if (data == '2') {
                            //return '<b class="fa fa-close" style="color:#ce3535;"></b>';
                            return '<a href="#" >Proses</a>'
                        }
                        if (data == '3') {
                            //return '<b class="fa fa-close" style="color:#ce3535;"></b>';
                            return '<a href="#" >Berkas Tidak Lengkap</a>'
                        }
                        if (data == '4') {
                            //return '<b class="fa fa-close" style="color:#ce3535;"></b>';
                            return '<a href="#" >Selesai</a>'
                        }
                        //else {
                        //    return '<b class="fa fa-check" style="color:#249c2f;"></b>';
                        //}
                    }
                },
                //{
                //    "data": "PengembalianPnbpId",
                //    "className": "centertaligncolumn",
                //    "width": "5%",
                //    render: function (data, type, row) {
                //        return '<a href="Pengembalian/PengajuanPengembalianDetail?pengembalianpnbpid='+data+'"><i class="fa fa-search" style="cursor: pointer;"></i></a>';
                //    }
                //},
                //{
                //    "data": "Hapus",
                //    "className": "centertaligncolumn",
                //    "width": "5%",
                //    render: function (data, type, row) {
                //        return '<u class="fa fa-trash" style="cursor: pointer;"></i>';
                //    }
                //}
            ],
            @*rowCallback: function (row, data) {
                if (@tipekantorid != "1") {
                    // base in zero
                    $('td', row).eq(2).hide();
                }
                if (@tipekantorid == "1") {
                    // base in zero
                    $('td', row).eq(8).hide();
                    $('td', row).eq(9).hide();
                }
            }*@
        });
    };

    $('#myTablePengembalianPnbp tbody').delegate('tr td', 'click', function (e) {
        var data = dtablePengajuan.row($(this).closest('tr')).data();
        if($('#jeniskantor').val()=='Pusat'){
            window.location.href = '@Url.Action("PengajuanPengembalianDetailPusat", "Pengembalian")?pengembalianpnbpid=' + data.PengembalianPnbpId;

            e.preventDefault();
            return false;
        }else{
            window.location.href = '@Url.Action("PengajuanPengembalianDetail", "Pengembalian")?pengembalianpnbpid=' + data.PengembalianPnbpId;

            e.preventDefault();
            return false;
        }
    });

    $('#myTablePengembalianPnbp tbody').delegate('tr u', 'click', function (e) {
        var data = dtablePengajuan.row($(this).closest('tr')).data();

        //showinfo(data.PengembalianPnbpId);

        var pengembalianpnbpid = data.PengembalianPnbpId;
        if (pengembalianpnbpid !== null && pengembalianpnbpid !== '') {
            swal({
                title: "Konfirmasi Hapus Data",
                text: "Yakin Anda mau menghapus data pengajuan berkas no. " + data.NomorBerkas + " (" + data.NamaPemohon + ") ?",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Ya",
                cancelButtonText: "Batal"
            },
            function (isConfirm) {
                if (isConfirm) {
                    $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
                    var frm = new FormData();
                    frm.append("pengembalianpnbpid", pengembalianpnbpid);
                    $.ajax({
                        url: '@Url.Action("HapusPengembalianPnbp", "Pengembalian")',
                        type: "POST",
                        data: frm,
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function (data, textStatus, jqXHR) {
                            if (data && data.Status) {
                                dtablePengajuan.ajax.reload(null, true);
                                showinfo('Data berhasil dihapus');
                            }
                            else {
                                showalert("Error", data.Pesan);
                            }
                            $.unblockUI();
                        },
                        error: function (jqXHR, textStatus, errorThrown) { showmsg("Error", errorThrown); $.unblockUI(); }
                    });
                }
            });
        }

        e.preventDefault();
        return false;
    });

</script>