<style type="text/css">
    .back-to-top {
        cursor: pointer;
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: none;
    }

    th {
        text-align: center;
    }
</style>
<script src='@Url.Content("~/resources/js/jquery.validate.min.js")' type="text/javascript"></script>
<script src='@Url.Content("~/resources/js/jquery.validate.unobtrusive.min.js")' type="text/javascript"></script>

<script src='@Url.Content("~/resources/js/moment.min.js")'></script>
<script src='@Url.Content("~/resources/js/id.js")'></script>
<script src='@Url.Content("~/resources/js/bootstrap-datetimepicker.min.js")'></script>


<link href='@Url.Content("~/resources/css/dataTables.bootstrap.min.css")' rel="stylesheet" />
<script src='@Url.Content("~/resources/js/jquery.dataTables.min.js")'></script>
<script src='@Url.Content("~/resources/js/dataTables.bootstrap.min.js")'></script>

<div id="dynamic_content">
    <div class="page-title">
        <div class="title_left">
        </div>
    </div>
    <div class="clearfix"></div>
    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Import Alokasi</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <form class="form-horizontal form-label-left" id="frmimportalok" method="post">
                        @Html.AntiForgeryToken()
                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12">Import File Alokasi</label>
                            <div class="col-md-6 col-sm-6 col-xs-12 hide-inputbtns">
                                <button type="button" id="btn-upload" disabled="true" class="btn btn-success btn-file"><i class="fa fa-file-pdf-o"></i>&nbsp;&nbsp;Pilih File<input type="file" disabled="true" name="UploadFromFile" id="fileAlokasi" class="btn btn-success" accept=".xls,.xlsx" /></button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12"></label>
                            <div class="col-md-6 col-sm-6 col-xs-12 hide-inputbtns">
                                <a href="@Url.Action("DownloadTemplateAlokasi", "Alokasi")" style="color:cornflowerblue" target="_blank">Download Template File Alokasi</a>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12"></label>
                            <div class="col-md-6 col-sm-6 col-xs-12 hide-inputbtns">
                                <button id="btn-alokasi" type="button" class="btn btn-success" disabled="true" style="margin-top:10px;"><i class="fa fa-paper-plane"></i>&nbsp;&nbsp;Proses Alokasi</button>
                                <button id="btn-reset-alokasi" type="button" class="btn btn-warning btn-group-crop" style="margin-top:10px;"><i class="fa fa-arrow-circle-o-right"></i>&nbsp;&nbsp;Reset Alokasi</button>
                                <button id="btn-kode-span" type="button" class="btn btn-danger btn-group-crop" style="display: none; margin-top: 10px;"><i class="fa fa-book"></i>&nbsp;&nbsp;Kode Span</button>
                                <button id="btn-kode-program" type="button" class="btn btn-danger btn-group-crop" style="display: none; margin-top: 10px;"><i class="fa fa-book"></i>&nbsp;&nbsp;Program</button>
                            </div>
                        </div>
                        <div class="form-group" id="notes" style="display: none;">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12"></label>
                            <div class="col-md-6 col-sm-6 col-xs-12 hide-inputbtns">
                                <span style="color:firebrick">Data Master Tidak Valid, Harap Isi Data Kode Span Dan Program</span>
                                <br />
                                <span style="color:firebrick">Silakan Click Button Kode Span Dan Program</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div style="text-align:center;">
                    <div style="text-align:center;">

                       
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tableholder">
    </div>

    <div class="x_panel">

        <form class="form-horizontal form-label-left pnbp-group-table" id="frmdatasatker" method="post" data-name="alokasi">
            @Html.AntiForgeryToken()
            <div class="form-group" id="group_alokasi">
                <div class="row text-center">
                    <label class="control-label"><h2><b>Riwayat MP</b></h2></label>
                </div>
                <table id="summaryalokasisatker" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>MP</th>
                            <th>Total Pagu</th>
                            <th>Total Alokasi</th>
                            <th>Total Belanja</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div>
                <br />
            </div>

            <div class="form-group" id="group_alokasi" style="margin-top:10px;">
                <div class="row text-center">
                    <label class="control-label"><h2><b>Data yang Akan DiAlokasikan</b></h2></label>
                </div>
                <table id="alokasisatker" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Kode Satker</th>
                            <th>Nama Satker</th>
                            <th>Pagu</th>
                            <th>Alokasi Saat Ini</th>
                            <th>Persentase</th>
                            @*<th class="text-center">
                            Y/N
                            <span>
                                <input type="checkbox" class="checkbox-inline checkall" onchange="tableCheckAll(this, '#group_alokasi')" />
                            </span>
                        </th>*@
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </form>

    </div>
</div>

<a id="back-to-top" href="#" class="btn btn-primary back-to-top" role="button" title="" data-toggle="tooltip" data-placement="left"><span class="glyphicon glyphicon-chevron-up"></span></a>

<script type="text/javascript">

    $(document).ready(function () {
        $(window).scroll(function () {
            if ($(this).scrollTop() > 50) {
                $('#back-to-top').fadeIn();
            } else {
                $('#back-to-top').fadeOut();
            }
        });
        // scroll body to 0px on click
        $('#back-to-top').click(function () {
            $('#back-to-top').tooltip('hide');
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });

        $('#back-to-top').tooltip('show');

        getValidateKodeSpan();
        getSummaryAlokasi();
        getAlokasi();
    });

    function addCommas(nStr) {
        nStr += '';
        x = nStr.split(',');
        x1 = x[0];
        x2 = x.length > 1 ? ',' + x[1] : '';
        var rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + '.' + '$2');
        }
        return x1 + x2;
    }

    var dfAlokasi = null;
    $("#fileAlokasi").on("change", function (e) {
        var input = $(this),
            numFiles = input.get(0).files ? input.get(0).files.length : 1;
        if (numFiles > 0) {
            var file = input.get(0).files[0]
            $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
            var frm = new FormData();
            frm.append("FileUpload", file);

            $.ajax({
                type: "POST",
                url: '@Url.Action("ReadAlokasi", "Alokasi")',
                data: frm,
                processData: false,
                contentType: false,
                success: function (res) {

                    var disable = false;
                    if (!res.success || res.data.data.length == 0) {
                        disable = true;
						swal({
							type: "error",
							html: true,
							title: "Gagal Memuat Data",
							confirmButtonColor: "#4CAF50",
                            allowOutsideClick: true,
							allowEscapeKey: true,
						});
                    } else {
                        if (res.success && res.data.valid) {
                            disable = false;
                        } else {
                            disable = true;
                        }

						swal({
							title: "Berhasil",
							text: "Data Berhasil Dimuat",
                            type: "success",
                            allowOutsideClick: true,
							allowEscapeKey: true,
						});
                    }
                    disable = false;

                    $('#btn-alokasi').prop('disabled', disable);
                    $('#btn-reset-alokasi').prop('disabled', disable);

                    writeDataTable(res);
                    $.unblockUI();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $.unblockUI();
					swal({
						type: "error",
						html: true,
						title: "Terjadi Kesalahan",
						confirmButtonColor: "#4CAF50",
						allowOutsideClick: true,
						allowEscapeKey: true,
					});
                },
                complete: function () {
                    input.val('');
                }
            });
        }
    });

    function getSummaryAlokasi() {
        $.ajax({
            type: "GET",
            url: '@Url.Action("SummaryAlokasi", "Alokasi")',
            success: function (res) {
                writeDataTableSummary(res);
            }, error: function (XMLHttpRequest, textStatus, errorThrown) {
            }
            });
    }

    function getAlokasi() {
        $.ajax({
            type: "GET",
            url: '@Url.Action("AlokasiSaatIni", "Alokasi")',
            success: function (res) {
                var disable = false;
                if (!res.success || res.data.data.length == 0) {
                    disable = true;
                } else {
                    if (res.success && res.data.valid) {
                        disable = false;
                    } else {
                        disable = true;
                    }
                }

                disable = false;

                $('#btn-alokasi').prop('disabled', disable);
                $('#btn-reset-alokasi').prop('disabled', disable);

                writeDataTable(res);
                $.unblockUI();
            }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.unblockUI();
            }
            });
    }

    function getValidateKodeSpan() {
        $.ajax({
            type: "GET",
            url: '@Url.Action("IsKodeSpanValid", "Alokasi")',
            success: function (res) {
                $('#fileAlokasi').prop('disabled', false);
                $('#btn-upload').prop('disabled', false);
                if (res.success && res.data) {
                    $('#btn-kode-span').hide();
                    $('#btn-kode-program').hide();
                    $('#notes').hide();
                    console.log("Kode Sapn Valid");
                } else {
                    $('#btn-alokasi').prop('disabled', true);
                    $('#btn-kode-span').show();
                    $('#btn-kode-program').show();
                    $('#notes').show();
                    console.log("Kode Sapn Not Valid");
                }
                $('#btn-alokasi').prop('disabled', false);

                $.unblockUI();
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.unblockUI();
            }});
    }

    $('#btn-kode-span').on('click', function () {
        window.location.href = '@Url.Action("Index", "KodeSpan")'
    });

    $('#btn-kode-program').on('click', function () {
        window.location.href = '@Url.Action("Index", "Program")'
    });

    $('#btn-reset-alokasi').on('click', function () {
        resetAlokasi();
    });

    $('#btn-alokasi').on('click', function () {
        prosesAlokasi();
    });

    function resetAlokasi() {
		$.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });

        $.ajax({
            type: "GET",
            url: '@Url.Action("ResetAlokasi", "Alokasi")',
            success: function (res) {
                if (res.success) {
                    swal({
                        title: "Berhasil",
                        text: "Berhasil Reset Alokasi",
                        type: "success",
                        allowOutsideClick: true,
                        allowEscapeKey: true,
                    });
                    //writeDataTable(res);
                    getAlokasi();
                } else {
					swal({
						type: "error",
						html: true,
						title: "Gagal Reset Alokasi",
						confirmButtonColor: "#4CAF50",
						allowOutsideClick: true,
						allowEscapeKey: true,
                    });
                }

                $('#btn-alokasi').prop('disabled', res.success);
                $('#btn-reset-alokasi').prop('disabled', res.success);

            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.unblockUI();
				swal({
					type: "error",
					html: true,
					title: "Terjadi Kesalahan",
					confirmButtonColor: "#4CAF50",
					allowOutsideClick: true,
					allowEscapeKey: true,
				});
            },
            complete: function () {
				$.unblockUI();
            }
        });
    }

    function prosesAlokasi() {
		$.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });

        $.ajax({
            type: "POST",
            url: '@Url.Action("ProsesAlokasi", "Alokasi")',
            success: function (res) {
                if (res.success) {
					swal({
						title: "Berhasil",
						text: "Data Berhasil Disimpan",
						type: "success",
                    }, function () {
                        window.location.reload();
                    });
                    writeDataTable(res);
                } else {
					swal({
						type: "error",
						html: true,
                        title: "Gagal Menyimpan Data",
                        text: res.message,
						confirmButtonColor: "#4CAF50",
						allowOutsideClick: true,
						allowEscapeKey: true,
					});
                }

                $('#btn-alokasi').prop('disabled', res.success);
                $('#btn-reset-alokasi').prop('disabled', res.success);

                },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
				swal({
					type: "error",
					html: true,
					title: "Terjadi kesalahan",
					confirmButtonColor: "#4CAF50",
					allowOutsideClick: true,
					allowEscapeKey: true,
				});
            },
            complete: function () {
				$.unblockUI();
            }
        });
    }

    function writeDataTable(res) {
        var html = "";
        if (res.data.data != null && res.data.data != undefined && res.data.data.length > 0) {
            var data = res.data.data;
            var i = 0;
            $.each(data, function (x) {
                i = x + 1;
                html += ""
                    + "<tr>"
                    + "<td class='text-center'>" + i + "</td>"
                    + "<td class='text-left'>" + data[x].KodeSatker + " <input type='hidden' id='kodesatker' name='kodesatker' value='" + data[x].kantorid + "'> </td>"
                    + "<td class='text-left'>" + data[x].NamaSatker + " <input type='hidden' id='namasatker' name='namasatker' value='" + data[x].namakantor + "'></td>"
                    + "<td class='text-right'>" + addCommas(data[x].Pagu) + "<input type='hidden' id='nilaianggaran' name='nilaianggaran' value='" + data[x].nilaianggaran + "'></td>"
                    + "<td class='text-right' "
                    + (data[x].Valid == 0 ? "style='color:red; font-weight: bold;'" : "")
                    + ">" + addCommas(data[x].Alokasi) + "<input type='hidden' id='totalalokasi' name='totalalokasi' value='" + data[x].totalalokasi + "'></td>"
                    + "<td class='text-right'>" + ((data[x].Alokasi / data[x].Pagu) * 100).toFixed(2) + "<input type='hidden' id='totalalokasi' name='totalalokasi' value='" + data[x].totalalokasi + "'></td>"
                    + "</tr>";
            });
            $("#index").val(i);
        } else {
            html = "<tr><td colspan='9' class='text-center'>Data Tidak Tersedia</td></tr>";
        }

        $("#alokasisatker>tbody").html(html);
    }

    function writeDataTableSummary(res) {
        var html = "";
        if (res.data != null && res.data != undefined && res.data.length > 0) {
            var data = res.data;
            var i = 0;
            $.each(data, function (x) {
                i = x + 1;
                html += ""
                    + "<tr>"
                    + "<td class='text-center'>" + i + "</td>"
                    + "<td class='text-left'>MP " + data[x].Mp + " <input type='hidden' id='kodesatker' name='kodesatker' value='" + data[x].kantorid + "'> </td>"
                    + "<td class='text-right'>" + addCommas(data[x].Pagu) + "<input type='hidden' id='nilaianggaran' name='nilaianggaran' value='" + data[x].nilaianggaran + "'></td>"
                    + "<td class='text-right'>" + addCommas(data[x].Alokasi) + "<input type='hidden' id='totalalokasi' name='totalalokasi' value='" + data[x].totalalokasi + "'></td>"
                    + "<td class='text-right'>" + addCommas(data[x].Belanja) + "</td>"
                    + "<td class='text-center' onclick='showDetailAlokasiSummary("
                    + "\"" + data[x].AlokasiSatkerSummaryId + "\""
                    + ");'> <i class='fa fa-eye'></i> </td>"
                    + "</tr>";
            });
            $("#index").val(i);
        } else {
            html = "<tr><td colspan='9' class='text-center'>Data Tidak Tersedia</td></tr>";
        }

        $("#summaryalokasisatker>tbody").html(html);
    }

    function showDetailAlokasiSummary(id) {
        $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
        $.pjax({
            container: '#dynamic_content',
            type: "GET",
            url: '@Url.Action("ImportAlokasiSummaryDetail", "Alokasi")?id=' + id + '',
            dataType: 'html',
            contentType: "application/json; charset=utf-8"
        });
    }

</script>


