
@model Pnbp.Entities.CariRincianAlokasiSatker
@{
    ViewBag.Title = "PengajuanPengembalianIndex";
    var tipekantorid = ViewData["tipekantorid"].ToString();
    var datasatker = ViewBag.datasatker;
    var kantoridclick = ViewBag.kantoridclick;
}
<style>
    .form-horizontal .left-label {
        padding-top: 8px !important;
    }

    .left-label {
        text-align: left !important;
    }
</style>
<div class="" id="dynamic_content">

    <div class="clearfix"></div>

    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel" style="padding-top:10px; border:1px solid #E6E9ED;">
                <div class="x_title">
                    <h2>Detail Rincian Alokasi</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <form class="form-horizontal form-label-left" id="frmCari" method="post">
                        <input type="hidden" name="KANTORID" id="KANTORID" value="@kantoridclick" />
                        <div class="row">
                            <div class="col-md-6 col-xs-12">
                                <div class="form-group">
                                    <label class="left-label col-md-4">Kode Satker : </label>
                                    <div class="left-label col-md-8">
                                        @datasatker.kode
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="left-label col-md-4">Nama Satker : </label>
                                    <div class="left-label col-md-8">
                                        @datasatker.Nama
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-xs-12 text-right">

                            </div>
                        </div>

                    </form>
                    <div class="text-right">


                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page-title">
        <div class="title_left"><h2 style="width:100%">Daftar Rincian Alokasi Per Output</h2></div>
        <div class="clearfix text-right">
            <a href="@Url.Action("RincianAlokasi", "Pemanfaatan")" class="btn btn-default"><i class="fa fa-arrow-left"></i> Kembali</a>
        </div>
    </div>

    <table id="rincianAlokasi" class="table table-striped table-bordered" style="width:100%; background-color:white;">
        <thead>
            <tr class="bg-primary">
                <th style="text-align:center;">No.</th>
                <th>Kode Output</th>
                <th>Nama Output</th>
                <th>Tipe</th>
                <th>Pagu</th>
                <th>Alokasi</th>
                <th>Realisasi Belanja</th>
                <th>%(Belanja Alokasi)</th>
                @*<th>%(Realisasi)</th>*@
            </tr>
        </thead>
        <tbody></tbody>
        @*<tfoot>
        <td></td>
        <td></td>
        <td></td>
        <th class="text-right">Total</th>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        </tfoot>*@
    </table>
</div>

<a id="back-to-top" href="#" class="btn btn-primary back-to-top" role="button" title="" data-toggle="tooltip" data-placement="left"><span class="glyphicon glyphicon-chevron-up"></span></a>

<script type="text/javascript">

    $(document).ready(function () {
        $('#CariKodeSatker').select2({
            placeholder: "Pilih Satker"
        });


        createPagingPengajuan();

        $(window).scroll(function () {
            if ($(this).scrollTop() > 50) {
                $('#back-to-top').fadeIn();
            } else {
                $('#back-to-top').fadeOut();
            }
        });
        // scroll body to 0px on click
        $('#back-to-top').click(function () {
            $('#back-to-top').tooltip('hide');
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });

        $('#back-to-top').tooltip('show');
    });

    $("#btnCreate").click(function (e) {
        window.location.href = '@Url.Action("EntriPengajuan", "Pengembalian")';

        e.preventDefault();
        return false;
    });

    $("#frmCari").submit(function (e) {
        dtablePengajuan.ajax.reload(null, true);
        e.preventDefault();
        return false;
    });

    var dtablePengajuan;
    var createPagingPengajuan = function () {
        dtablePengajuan = $('#rincianAlokasi').DataTable({
            "bLengthChange": false,
            "paging": false,
            "pageLength": false,
            "bFilter": false,
            "ordering": false,
            "info": false,
            "processing": true,
            "serverSide": true,
            "scrollX": false,
            "ajax": {
                url: '@Url.Action("DaftarRincianAlokasiDetail", "Pemanfaatan")',
                type: "POST",
                data: function (data, obj) { var ftp = $('#frmCari').serializeArray(); data.form = ftp; ftp.push({ name: "start", value: data.start }, { name: "length", value: data.length }); return ftp; }
            },
            "columns": [
                { "data": "RNumber", "className": "centertaligncolumn", "width": "5%" },
                { "data": 'KODEOUTPUT' },
                { "data": 'NAMAOUTPUT' },
                { "data": 'TIPE' },
                { "data": "PAGU", "className": "rightaligncolumn", render: formatangka },
                { "data": "ALOKASI", "className": "rightaligncolumn", render: formatangka },
                { "data": "REALISASIBELANJA", "className": "rightaligncolumn", render: formatangka },
                { "data": "PERSENALOKASI" },

            ],
            "footerCallback": function (row, data, start, end, display) {
                var api = this.api(), data;

                // converting to interger to find total
                var intVal = function (i) {
                    return typeof i === 'string' ?
                        i.replace(/[\$,]/g, '') * 1 :
                        typeof i === 'number' ?
                        i : 0;
                };

                // computing column Total of the complete result
                var pagu = api
                    .column(4)
                    .data()
                    .reduce(function (a, b) {
                        return intVal(a) + intVal(b);
                    }, 0);

                var alokasi = api
                        .column(5)
                        .data()
                        .reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                var realisasi = api
                    .column(7)
                    .data()
                    .reduce(function (a, b) {
                        return intVal(a) + intVal(b);
                    }, 0);


                // Update footer by showing the total with the reference of the column index

                $(api.column(4).footer()).html(addCommas(pagu));
                $(api.column(5).footer()).html(addCommas(alokasi));
                $(api.column(7).footer()).html(addCommas(realisasi));
            },

        });
    };

    //$('#rincianAlokasi tbody').delegate('tr td', 'click', function (e) {
    //    var data = dtablePengajuan.row($(this).closest('tr')).data();

    //    window.location.href = '@Url.Action("PengajuanPengembalianDetail", "Pengembalian")?pengembalianpnbpid=' + data.PengembalianPnbpId;

    //    e.preventDefault();
    //    return false;
    //});

    $('#rincianAlokasi tbody').delegate('tr u', 'click', function (e) {
        var data = dtablePengajuan.row($(this).closest('tr')).data();

        //showinfo(data.PengembalianPnbpId);

        var pengembalianpnbpid = data.PengembalianPnbpId;
        if (pengembalianpnbpid !== null && pengembalianpnbpid !== '') {
            swal({
                title: "Konfirmasi Hapus Data",
                text: "Yakin Anda mau menghapus data pengajuan berkas no. " + data.NomorBerkas + " (" + data.NamaPemohon + ") ?",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Ya",
                cancelButtonText: "Batal"
            },
            function (isConfirm) {
                if (isConfirm) {
                    $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
                    var frm = new FormData();
                    frm.append("pengembalianpnbpid", pengembalianpnbpid);
                    $.ajax({
                        url: '@Url.Action("HapusPengembalianPnbp", "Pengembalian")',
                        type: "POST",
                        data: frm,
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function (data, textStatus, jqXHR) {
                            if (data && data.Status) {
                                dtablePengajuan.ajax.reload(null, true);
                                showinfo('Data berhasil dihapus');
                            }
                            else {
                                showalert("Error", data.Pesan);
                            }
                            $.unblockUI();
                        },
                        error: function (jqXHR, textStatus, errorThrown) { showmsg("Error", errorThrown); $.unblockUI(); }
                    });
                }
            });
        }

        e.preventDefault();
        return false;
    });
    $('#btnReset').click(function (e) {
        location.reload();
    });

    function addCommas(nStr) {
        nStr += '';
        x = nStr.split(',');
        x1 = x[0];
        x2 = x.length > 1 ? ',' + x[1] : '';
        var rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + '.' + '$2');
        }
        return x1 + x2;
    }
</script>
