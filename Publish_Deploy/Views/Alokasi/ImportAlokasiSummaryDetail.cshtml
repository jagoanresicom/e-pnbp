<style type="text/css" nonce="MjI3NzUzMQ">
    .back-to-top {
        cursor: pointer;
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: none;
    }

    th {
        text-align: center;
    }
</style>
<script src='@Url.Content("~/resources/js/jquery.validate.min.js")' type="text/javascript"></script>
<script src='@Url.Content("~/resources/js/jquery.validate.unobtrusive.min.js")' type="text/javascript"></script>

<script src='@Url.Content("~/resources/js/moment.min.js")'></script>
<script src='@Url.Content("~/resources/js/id.js")'></script>
<script src='@Url.Content("~/resources/js/bootstrap-datetimepicker.min.js")'></script>


<link href='@Url.Content("~/resources/css/dataTables.bootstrap.min.css")' rel="stylesheet" />
<script src='@Url.Content("~/resources/js/jquery.dataTables.min.js")'></script>
<script src='@Url.Content("~/resources/js/dataTables.bootstrap.min.js")'></script>

<div id="dynamic_content">
    <div class="page-title">
        <div class="title_left">
        </div>
    </div>
    <div class="clearfix"></div>
    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Detail Import Alokasi</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <form class="form-horizontal form-label-left" id="frmimportalok" method="post">
                        @Html.AntiForgeryToken()
                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12">Import File Revisi Alokasi</label>
                            <div class="col-md-6 col-sm-6 col-xs-12 hide-inputbtns">
                                <button type="button" id="btn-upload" disabled="true" class="btn btn-success btn-file"><i class="fa fa-file-pdf-o"></i>&nbsp;&nbsp;Pilih File<input type="file" disabled="true" name="UploadFromFile" id="fileAlokasi" class="btn btn-success" accept=".xls,.xlsx" /></button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12"></label>
                            <div class="col-md-6 col-sm-6 col-xs-12 hide-inputbtns">
                                <a href="@Url.Action("DownloadTemplateAlokasi", "Alokasi")" style="color:cornflowerblue" target="_blank">Download Template File Alokasi</a>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12"></label>
                            <div class="col-md-6 col-sm-6 col-xs-12 hide-inputbtns">
                                <button id="btn-alokasi" type="button" class="btn btn-success" disabled="true" style="margin-top:10px;"><i class="fa fa-paper-plane"></i>&nbsp;&nbsp;Proses Revisi Alokasi</button>
                                <button id="btn-reset-alokasi" type="button" class="btn btn-warning btn-group-crop" style="margin-top:10px;"><i class="fa fa-arrow-circle-o-right"></i>&nbsp;&nbsp;Reset Alokasi</button>
                                <button id="btn-kode-span" type="button" class="btn btn-danger btn-group-crop" style="display: none; margin-top: 10px;"><i class="fa fa-book"></i>&nbsp;&nbsp;Kode Span</button>
                                <button id="btn-kode-program" type="button" class="btn btn-danger btn-group-crop" style="display: none; margin-top: 10px;"><i class="fa fa-book"></i>&nbsp;&nbsp;Program</button>
                            </div>
                        </div>
                        <div class="form-group" id="notes" style="display: none;">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12"></label>
                            <div class="col-md-6 col-sm-6 col-xs-12 hide-inputbtns">
                                <span style="color:firebrick">Data Master Tidak Valid, Harap Isi Data Kode Span Dan Program</span>
                                <br />
                                <span style="color:firebrick">Silakan Click Button Kode Span Dan Program</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div style="text-align:center;">
                    <div style="text-align:center;">

                       
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tableholder">
    </div>

    <div class="x_panel">

        <form class="form-horizontal form-label-left pnbp-group-table" id="frmdatasatker" method="post" data-name="alokasi">
            @Html.AntiForgeryToken()
            <div class="form-group" id="group_alokasi" style="margin-top:10px;">
                <table id="alokasisatker" class="table table-striped table-bordered">
                    <thead>
                        <tr id="group_total">
                            <th colspan="3" class="numeric">Total</th>
                            <th></th>
                        </tr>
                        <tr>
                            <th>No</th>
                            <th>Kode Satker</th>
                            <th>Nama Satker</th>
                            <th>Pagu</th>
                            @*<th>Alokasi Saat Ini</th>*@
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>

<a id="back-to-top" href="#" class="btn btn-primary back-to-top" role="button" title="" data-toggle="tooltip" data-placement="left"><span class="glyphicon glyphicon-chevron-up"></span></a>

<script type="text/javascript" nonce="MjI3NzUzMQ">

    $(document).ready(function () {
        $(window).scroll(function () {
            if ($(this).scrollTop() > 50) {
                $('#back-to-top').fadeIn();
            } else {
                $('#back-to-top').fadeOut();
            }
        });
        // scroll body to 0px on click
        $('#back-to-top').click(function () {
            $('#back-to-top').tooltip('hide');
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });

        $('#back-to-top').tooltip('show');

        getValidateKodeSpan();
        getAlokasi();
    });

    function addCommas(nStr) {
        nStr += '';
        x = nStr.split(',');
        x1 = x[0];
        x2 = x.length > 1 ? ',' + x[1] : '';
        var rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + '.' + '$2');
        }
        return x1 + x2;
    }

    var dfAlokasi = null;
    $("#fileAlokasi").on("change", function (e) {
        var input = $(this),
            numFiles = input.get(0).files ? input.get(0).files.length : 1;
        if (numFiles > 0) {
            var file = input.get(0).files[0]
            $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
            var frm = new FormData();
            frm.append("FileUpload", file);

            $.ajax({
                type: "POST",
                url: '@Url.Action("ReadAlokasiRevisi", "Alokasi")',
                data: frm,
                processData: false,
                contentType: false,
                success: function (res) {
                    if (!res.success || res.data.length == 0) {
						swal({
							type: "error",
							html: true,
							title: "Gagal Memuat Data",
							confirmButtonColor: "#4CAF50",
							allowOutsideClick: true,
							allowEscapeKey: true,
                        });
                        $('#btn-alokasi').prop('disabled', true);
                        $('#btn-reset-alokasi').prop('disabled', true);
                    } else {
                        $('#btn-alokasi').prop('disabled', false);
                        $('#btn-reset-alokasi').prop('disabled', false);
						swal({
							title: "Berhasil",
							text: "Data Berhasil Dimuat",
							type: "success",
                        }, function () {
						    location.reload();
                        });
                    }

                    //writeDataTable(res);
                    $.unblockUI();
                    //getAlokasi();
                    //location.reload();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $.unblockUI();
					swal({
						type: "error",
						html: true,
						title: "Terjadi kesalahan",
						confirmButtonColor: "#4CAF50",
						allowOutsideClick: true,
						allowEscapeKey: true,
					});
                },
				complete: function () {
					input.val('');
				}
            });
        }
    });

    function getAlokasi() {
        var urlObject = new URL(document.location.href);
        var params = urlObject.searchParams;
        var id = params.get("id");
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetAlokasiBySummaryId", "Alokasi")?id='+id,
            success: function (res) {
                if (!res.success || res.data.length == 0) {
                    $('#btn-alokasi').prop('disabled', true);
                    $('#btn-reset-alokasi').prop('disabled', true);
                } else {
                    $('#btn-alokasi').prop('disabled', false);
                    $('#btn-reset-alokasi').prop('disabled', false);
                }

                writeDataTable(res);
                $.unblockUI();
            }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.unblockUI();
            }
            });
    }

    function getValidateKodeSpan() {
        $.ajax({
            type: "GET",
            url: '@Url.Action("IsKodeSpanValid", "Alokasi")',
            success: function (res) {
                $('#fileAlokasi').prop('disabled', false);
                $('#btn-upload').prop('disabled', false);
                if (res.success && res.data) {
                    $('#btn-kode-span').hide();
                    $('#btn-kode-program').hide();
                    $('#notes').hide();
                    console.log("Kode Sapn Valid");
                } else {
                    $('#btn-alokasi').prop('disabled', true);
                    $('#btn-kode-span').show();
                    $('#btn-kode-program').show();
                    $('#notes').show();
                    console.log("Kode Sapn Not Valid");
                }
                $.unblockUI();
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.unblockUI();
            }});
    }

    $('#btn-kode-span').on('click', function () {
        window.location.href = '@Url.Action("Index", "KodeSpan")'
    });

    $('#btn-kode-program').on('click', function () {
        window.location.href = '@Url.Action("Index", "Program")'
    });

    $('#btn-reset-alokasi').on('click', function () {
        resetAlokasi();
    });

    $('#btn-alokasi').on('click', function () {
        prosesAlokasi();
    });

    function resetAlokasi() {
		$.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
        $.ajax({
            type: "GET",
            url: '@Url.Action("ResetAlokasiRevisi", "Alokasi")',
            success: function (res) {
                if (res.success) {
                    swal({
                        title: "Berhasil",
                        text: "Berhasil Reset Alokasi Revisi",
                        type: "success",
                    }, function () {
                        window.location.reload();
                    });
                    //getAlokasi();
                } else {
					swal({
						type: "error",
						html: true,
						title: "Gagal Reset Alokasi Revisi",
						confirmButtonColor: "#4CAF50",
						allowOutsideClick: true,
						allowEscapeKey: true,
					});
                }

                $('#btn-alokasi').prop('disabled', res.success);
                $('#btn-reset-alokasi').prop('disabled', res.success);

            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
				swal({
					type: "error",
					html: true,
					title: "Terjadi Kesalahan",
					confirmButtonColor: "#4CAF50",
					allowOutsideClick: true,
					allowEscapeKey: true,
				});
            },
			complete: function () {
				$.unblockUI();
			}
        });
    }

    function prosesAlokasi() {
		$.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
        $.ajax({
            type: "POST",
            url: '@Url.Action("ProsesRevisiAlokasi", "Alokasi")',
            success: function (res) {
                if (res.success) {
                    //writeDataTable(res);
					swal({
						title: "Berhasil",
						text: "Data Berhasil Disimpan",
						type: "success",
                    }, function () {
                        location.reload();
                    });
                } else {
					swal({
						type: "error",
						html: true,
						title: "Gagal Menyimpan Data",
						confirmButtonColor: "#4CAF50",
						allowOutsideClick: true,
						allowEscapeKey: true,
					});
                }

                $('#btn-alokasi').prop('disabled', res.success);
                $('#btn-reset-alokasi').prop('disabled', res.success);

            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
				swal({
					type: "error",
					html: true,
					title: "Terjadi kesalahan",
					confirmButtonColor: "#4CAF50",
					allowOutsideClick: true,
					allowEscapeKey: true,
				});
            },
            complete: function () {
				$.unblockUI();
            }
        });
    }

    function writeDataTable(res) {
        var html = "";
        if (res.data.Data != null && res.data.Data != undefined && res.data.Data.length > 0) {
            var data = res.data.Data;
            var i = 0;

            var trTotal = document.getElementById('alokasisatker').tHead.children[0];
            var tr = document.getElementById('alokasisatker').tHead.children[1];
            if (data[0].DaftarRevisi != null && data[0].DaftarRevisi.length > 0) {
                var th = document.createElement('th');
                th.innerHTML = "Alokasi 1";
                tr.appendChild(th);
				trTotal.appendChild(document.createElement('th'));

                $.each(data[0].DaftarRevisi, function (x) {
                    var th = document.createElement('th');
                    if ((x + 1) == data[0].DaftarRevisi.length) {
                        th.innerHTML = "Alokasi Saat Ini";
                    } else {
                        th.innerHTML = "Alokasi " + (x + 2);
                    }
                    tr.appendChild(th);
					trTotal.appendChild(document.createElement('th'));
                });
            } else {
                var th = document.createElement('th');
                th.innerHTML = "Alokasi Saat Ini";
                tr.appendChild(th);
				trTotal.appendChild(document.createElement('th'));
            }

            if (data[0].TempAlokasi != null) {
                var th = document.createElement('th');
                th.innerHTML = "Revisi Alokasi";
                tr.appendChild(th);
				trTotal.appendChild(document.createElement('th'));
            }

            $.each(data, function (x) {
                i = x + 1;
                html += ""
                    + "<tr>"
                    + "<td class='text-center'>" + i + "</td>"
                    + "<td class='text-left'>" + data[x].KodeSatker + " </td>"
                    + "<td class='text-left'>" + data[x].NamaSatker + " </td>"
                    + "<td class='text-right'>" + addCommas(data[x].Pagu) + "</td>"
                    + "<td class='text-right'>" + addCommas(data[x].Alokasi) + "</td>"
                    ;

                if (data[x].DaftarRevisi != null && data[x].DaftarRevisi.length > 0) {
                    for (var index = 0; index < data[x].DaftarRevisi.length; index++) {
                        html += ""
                            + "<td class='text-right'>" + addCommas(data[x].DaftarRevisi[index].Alokasi) + "</td>";
                    }
                }

                if (data[x].TempAlokasi != null) {
                    html += ""
                        + "<td class='text-right' " 
                        + (data[x].IsNilaiBaru ? "style='color: red; font-weight: bold;'" : "")
                        + ">" + addCommas(data[x].TempAlokasi) + "</td>";
                }

                html += "</tr>"
            });
            $("#index").val(i);
        } else {
            html = "<tr><td colspan='9' class='text-center'>Data Tidak Tersedia</td></tr>";
        }

        $("#alokasisatker>tbody").html(html);

		showDetailAlokasi(res.data.Total);
    }

    function showDetailAlokasi(data) {
        let childIndex = 2; // start column
		$.each(data, function (index) {
			$('#group_total>th:nth-child(' + childIndex + ')').html(addCommas(data[index].Alokasi));
            childIndex++;
		});
    }

</script>


